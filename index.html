<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Player Online</title>
<style>
body {
    font-family: Arial, sans-serif;
    word-wrap: break-word;
    background-color: white;
    color: black;
}
img {
    height: 20px;
    float: right;
    border-radius: 15%;
}
.folder {
	margin: 10px;
    border: 2px solid #cecece;
    border-radius: 12px;
    padding: 5px;
    background-color: #fff;
}
.file {
	margin: 10px;
    border: 2px solid black;
    border-radius: 5px;
    padding: 5px;
    background-color: #cecece;
}
.mediabar {
    display: flex;
    position: fixed;
    width: 100%;
    bottom: 0;
    left: 0;
    background-color: #fbfbfb;
    box-shadow: 0px 0px 10px #848484;
    justify-content: center;
    gap: 20px;
    padding-top: 25px;
    padding-bottom: 25px;
    align-content: center;
    border-top-right-radius: 10px;
    border-top-left-radius: 10px;
}
.audioblock {
    width: 100%;
    justify-content: center;
    box-sizing: border-box;
    display: grid;
}
.infoblock {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 15px;
    padding-left: 25px;
}
.sliderdiv {
    gap: 25px;
    display: flex;
    align-items: center;
}
.slider {
    width: 100%;
}
</style>
</head>
<body>

<div style="text-align: center;">
    <input type="file" id="filepicker" name="fileList" webkitdirectory directory multiple />
</div>

<div class="mediabar" id="mediabar" style="display:none;">
    <div class="infoblock" id="infoblock">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Cat03.jpg/1200px-Cat03.jpg" id="infoimg" style="width: 60px;height: auto;">
	<p id="infoname">Song_name_here.mp3</p>    
    </div>
    <div class="audioblock">
	    <div class="sliderdiv">
		<button id="shuffle" onclick="media('shuffle');">shuffle</button>
		<button id="previous" onclick="media('prev')">prev</button>
		<button id="playpause" onclick="media('play')">play</button>
		<button id="next" onclick="media('next')">next</button>
		<button id="loop" onclick="media('loop');">loop</button>
	    </div>
	    <div class="sliderdiv">
		<div id="time">0:00</div>
		<input type="range" min="0" max="100" value="0" class="slider" id="seekbar">
		<div id="time2">0:00</div>
		<audio id="audioPlayer">
		    <source id="audioSource" type="audio/mpeg">
		</audio>
	    </div>
    </div>
    <div style="width:100%;" id="volumeblock"></div>
</div>
<div id="folders"></div>
<div style="height: 116px;"></div>
	
<script>
const folders = document.getElementById('folders');
const filepicker = document.getElementById('filepicker');
var audiolinks = [];
var imagelinks = {};
var lastplayed = 0;
var prev = [];
var loop = false;
var shuffle = false;

const audioPlayer = document.querySelector("#audioPlayer");
const audioSource = document.querySelector("#audioSource");
const shufflebtn = document.querySelector("#shuffle");
const loopbtn = document.querySelector("#loop");
const previousbtn = document.querySelector("#previous");
const nextbtn = document.querySelector("#next");
const playpausebtn = document.querySelector("#playpause");
const seekbar = document.querySelector("#seekbar");
const mediabar = document.querySelector("#mediabar");
const infoblock = document.getElementById("infoblock");
const infoimg = document.getElementById("infoimg");
const infoname = document.getElementById("infoname");
const volumeblock = document.getElementById("volumeblock");
	
function resize() {
    if (document.getElementById("mediabar").offsetWidth > 846) {
	infoblock.style.display = "";
        volumeblock.style.display = "";
    } else {
    	infoblock.style.display = "none";
    	volumeblock.style.display = "none";
    }
}
resize();
window.onresize = resize;
	
function stopclick() {
    if (!e) var e = window.event;
    e.cancelBubble = true;
    if (e.stopPropagation) e.stopPropagation();
}

const calculateTime = (secs) => {
    const minutes = Math.floor(secs / 60);
    const seconds = Math.floor(secs % 60);
    const returnedSeconds = seconds < 10 ? `0${seconds}` : `${seconds}`;
    return `${minutes}:${returnedSeconds}`;
}

function updatebar() {
    if (seekbar.max != Math.floor(audioPlayer.duration*100)) {
      seekbar.max = Math.floor(audioPlayer.duration*100);
    }
    if (seekbar.value != Math.floor(audioPlayer.currentTime*100)) {
      seekbar.value = Math.floor(audioPlayer.currentTime*100);
    }
    
    if (document.getElementById("time").innerText != calculateTime(Math.floor(audioPlayer.currentTime))) {
      document.getElementById("time").innerText = calculateTime(Math.floor(audioPlayer.currentTime));
    }
    if (document.getElementById("time2").innerText != calculateTime(audioPlayer.duration)) {
      document.getElementById("time2").innerText = calculateTime(audioPlayer.duration);
    }
}
setInterval(updatebar, 100);

seekbar.oninput = function() {
  audioPlayer.currentTime = seekbar.value/100;
}

function random(max) {
  return Math.floor(Math.random() * max);
}

function playmem(n) {
    if (prev.length > 100) {
        prev.splice(0,prev.length-99);
    }
    prev.push(n);
}

function media(action) {
    if (action == "play") {
        if (audioPlayer.paused) {
            audioPlayer.play();
        } else {
            audioPlayer.pause();
        }
    }
    if (action == "loop") {
        if (loop) {
            loop = false;
            loopbtn.style = "";
        } else {
            loop = true;
            loopbtn.style.color = "#009b00";
        }
    }
    if (action == "shuffle") {
        if (shuffle) {
            shuffle = false;
            shufflebtn.style = "";
        } else {
            shuffle = true;
            shufflebtn.style.color = "#009b00";
        }
    }
    if (action == "prev") {
        if (shuffle && prev.length > 1) { 
            if (prev.length == 2) { 
                prev.splice(prev.length-1,prev.length); 
                playaudio(random(audiolinks.length-1)); 
                return; 
            } 
            playaudio(prev[prev.length-2]); 
            prev.splice(prev.length-2,prev.length); 
        } else { 
            playaudio(lastplayed-1); 
        }
    }
    if (action == "next") {
        if (shuffle) { 
            playaudio(random(audiolinks.length-1)); 
        } else { 
            playaudio(lastplayed+1) 
        } 
    }
}

function hideshow(id) {
    var element = document.getElementById(id);
    if (element.style.display == "" || element.style.display == "none") {
        element.style.display = "block";
    } else {
        element.style.display = "none";
    }
}

function base64ToBlob(base64) {
  const byteString = atob(base64.split(',')[1]);
  const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
  const buffer = new ArrayBuffer(byteString.length);
  const view = new Uint8Array(buffer);
  for (let i = 0; i < byteString.length; i++) {
    view[i] = byteString.charCodeAt(i);
  }
  return new Blob([view], { type: mimeString });
}

async function blob64(url) {
  const response = await fetch(url);
  const blob = await response.blob();
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = () => {
      resolve(reader.result);
    };
    reader.readAsDataURL(blob);
  });
}

async function scaleimage(url, width, height) {
    var imgDataUrl = await blob64(url);
    var img = new Image();
    img.src = imgDataUrl;

    return new Promise((resolve, reject) => {
      img.onload = function() {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL());
      };
      img.onerror = reject;
    });
}

async function playaudio(i) {
    if (mediabar.style.display == "none") {
    	mediabar.style.display = "";
	resize();
    }
    if (i > audiolinks.length-1) {
        i = 0;
    }
    if (i < 0) {
        i = audiolinks.length-1;
    }
    playmem(i);
    const audiofolder = audiolinks[i][0].split("/")[audiolinks[i][0].split("/").length-2];
    var albumimage = [];
    if (imagelinks[audiofolder]) {
        albumimage = [
            { src: await scaleimage(imagelinks[audiofolder][0][1], 256, 256), sizes: '256x256', type: 'image/png' },
        ];
	//albumimage = [
        //    { src: imagelinks[audiofolder][0][1], type: 'image/png' },
        //]
    }
    infoimg.src = albumimage[0].src;
    infoname = audiolinks[i][0].split("/").pop();
    audioSource.src = audiolinks[i][1];
    audioPlayer.load();
    audioPlayer.play().then(_ => { 
        if ('mediaSession' in navigator) {

            navigator.mediaSession.metadata = new MediaMetadata({
            title: audiolinks[i][0].split("/").pop(),
	    artist: '',
      	    album: '',
            artwork: albumimage,
            });
            
        }
    })
    .catch(error => { console.log(error) });
    const actionHandlers = [
        ['play',          () => { audioPlayer.play(); }],
        ['pause',         () => { audioPlayer.pause(); }],
        ['previoustrack', () => { media("prev"); }],
        ['nexttrack',     () => { media("next"); }],
        ['stop',          () => { audioPlayer.pause();audioPlayer.currentTime = 0; }],
        //['seekbackward',  (details) => { audioPlayer.currentTime = audioPlayer.currentTime-(details.seekOffset || 10); }],
        //['seekforward',   (details) => { audioPlayer.currentTime = audioPlayer.currentTime+(details.seekOffset || 10); }],
        ['seekto',        (details) => { 
            if (details.fastSeek && 'fastSeek' in audioPlayer) {
                audioPlayer.fastSeek(details.seekTime);
                return;
            }
            audioPlayer.currentTime = details.seekTime;
        }],
    ];

    for (const [action, handler] of actionHandlers) {
        try {
        navigator.mediaSession.setActionHandler(action, handler);
        } catch (error) {
        console.log(`The media session action "${action}" is not supported yet.`);
        }
    }

    for (let i = 0; i < document.getElementsByClassName("file").length; i++) { 
        document.getElementsByClassName("file")[i].style = "";
    }
    document.getElementById(audiolinks[i][0]).style.color = "#009b00";
    lastplayed = i;
}

audioPlayer.addEventListener("ended", function() {
    if (!loop) {
        lastplayed = lastplayed+1;
    }
    if (shuffle && !loop) {
        lastplayed = random(audiolinks.length-1);
    }
    playaudio(lastplayed);
});

audioPlayer.addEventListener("play", function() {
    playpausebtn.innerText = "pause";
});

audioPlayer.addEventListener("pause", function() {
    playpausebtn.innerText = "play";
});

filepicker.addEventListener('change', (event) => {
  	const files = event.target.files;
    var newfiles = Object.values(files).sort((a, b) => b.webkitRelativePath.split("/").length - a.webkitRelativePath.split("/").length);
  	for (let i = 0; i < newfiles.length; i++) {
        const file = newfiles[i];
        var imagesplit = file.webkitRelativePath.split("/");
        if (file.type.startsWith("image/") && !file.webkitRelativePath.split("/").pop().startsWith(".")) {
            var imgfolder = imagesplit[imagesplit.length-2];
            if (!imagelinks[imgfolder]) {
                imagelinks[imgfolder] = [];
            }
            imagelinks[imgfolder].push([file.webkitRelativePath, URL.createObjectURL(file), file.type]);
        }
        if (file.type.startsWith("audio") && !file.webkitRelativePath.split("/").pop().startsWith(".")) {
            const filesplit = file.webkitRelativePath.split("/");
            for (let i = 0; i < filesplit.length; i++) {
                var parent = document.querySelector('[id="'+filesplit[i-1]+'"]');
                var fileholderdiv = document.querySelector('[id="f'+filesplit[i-1]+'"]');
                if (!fileholderdiv) {
                    fileholderdiv = document.createElement("div");
                }
                fileholderdiv.id = "f"+filesplit[i-1];
                fileholderdiv.style.display = "none";
                if (i == 0) {
                    parent = document.querySelector('[id="folders"]');
                } 
                if (i+1 != filesplit.length && !parent.querySelector('[id="'+filesplit[i]+'"]')) {
                    var folderdiv = document.createElement("div");
                    folderdiv.id = filesplit[i];
                    folderdiv.className = "folder";
                    var folderimg = document.createElement("img");
                    var foldername = document.createElement("div");
                    foldername.innerText = filesplit[i];
                    foldername.setAttribute("onclick", "hideshow('f"+filesplit[i]+"')");
                    folderimg.id = filesplit[i]+"img";
                    foldername.appendChild(folderimg);
                    folderdiv.appendChild(foldername);
                    if (i == 0) {
                        parent.appendChild(folderdiv);
                    } else {
                        fileholderdiv.appendChild(folderdiv);
                        parent.appendChild(fileholderdiv); 
                    }
                } else if (i+1 == filesplit.length && !document.querySelector('[id="'+file.webkitRelativePath+'"]')) {
                    var filediv = document.createElement("div");
                    filediv.id = file.webkitRelativePath;
                    filediv.className = "file";
                    filediv.innerText = filesplit[i];
                    audiolinks.push([file.webkitRelativePath, URL.createObjectURL(file)]);
                    filediv.setAttribute("onclick", 'playaudio('+(audiolinks.length-1)+');');
                    fileholderdiv.appendChild(filediv);
                    parent.appendChild(fileholderdiv); 
                } 
            }
        }
	}
    for (let i = 0; i < document.getElementsByTagName("img").length; i++) { 
        let id = document.getElementsByTagName("img")[i].id.slice(0,-3);
        if (imagelinks[id]) {
            document.getElementsByTagName("img")[i].src = imagelinks[id][0][1];
        }
    }
});
</script>

</body>
</html>
