<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Player Online</title>
<style>
body {
    font-family: Arial, sans-serif;
    background-color: white;
    color: black;
}
.folder {
	margin: 10px;
    border: 2px solid #cecece;
    border-radius: 12px;
    padding: 5px;
    background-color: #fff;
}
.file {
	margin: 10px;
    border: 2px solid black;
    border-radius: 5px;
    padding: 5px;
    background-color: #cecece;
}
</style>
</head>
<body>

<input type="file" id="filepicker" name="fileList" webkitdirectory directory multiple />
<audio id="audioPlayer" controls>
    <source id="audioSource" type="audio/mpeg">
</audio>
<button id="shuffle" onclick="media('shuffle');">shuffle</button>
<button id="previous" onclick="media('prev')">prev</button>
<button id="playpause" onclick="media('play')">play</button>
<button id="next" onclick="media('next')">next</button>
<button id="loop" onclick="media('loop');">loop</button>
<div id="folders"><div>

<script>
const folders = document.getElementById('folders');
const filepicker = document.getElementById('filepicker');
var audiolinks = [];
var lastplayed = 0;
var prev = [];
var loop = false;
var shuffle = false;

const audioPlayer = document.querySelector("#audioPlayer");
const audioSource = document.querySelector("#audioSource");
const shufflebtn = document.querySelector("#shuffle");
const loopbtn = document.querySelector("#loop");
const previousbtn = document.querySelector("#previous");
const nextbtn = document.querySelector("#next");
const playpausebtn = document.querySelector("#playpause");

function random(max) {
  return Math.floor(Math.random() * max);
}

function playmem(n) {
    if (prev.length > 100) {
        prev.splice(0,prev.length-99);
    }
    prev.push(n);
}

function media(action) {
    if (action == "play") {
        if (audioPlayer.paused) {
            audioPlayer.play();
        } else {
            audioPlayer.pause();
        }
    }
    if (action == "loop") {
        if (loop) {
            loop = false;
            loopbtn.style = "";
        } else {
            loop = true;
            loopbtn.style.color = "#009b00";
        }
    }
    if (action == "shuffle") {
        if (shuffle) {
            shuffle = false;
            shufflebtn.style = "";
        } else {
            shuffle = true;
            shufflebtn.style.color = "#009b00";
        }
    }
    if (action == "prev") {
        if (shuffle && prev.length > 1) { 
            if (prev.length == 2) { 
                prev.splice(prev.length-1,prev.length); 
                playaudio(random(audiolinks.length-1)); 
                return; 
            } 
            playaudio(prev[prev.length-2]); 
            prev.splice(prev.length-2,prev.length); 
        } else { 
            playaudio(lastplayed-1); 
        }
    }
    if (action == "next") {
        if (shuffle) { 
            playaudio(random(audiolinks.length-1)); 
        } else { 
            playaudio(lastplayed+1) 
        } 
    }
}



function playaudio(i) {
    if (i > audiolinks.length-1) {
        i = 0;
    }
    if (i < 0) {
        i = audiolinks.length-1;
    }
    playmem(i);
    audioSource.src = audiolinks[i][1];
    audioPlayer.load();
    audioPlayer.play().then(_ => { 
        if ('mediaSession' in navigator) {

            navigator.mediaSession.metadata = new MediaMetadata({
            title: audiolinks[i][0].split("/").pop(),
            artwork: [
                { src: 'https://dummyimage.com/96x96',   sizes: '96x96',   type: 'image/png' },
                { src: 'https://dummyimage.com/128x128', sizes: '128x128', type: 'image/png' },
                { src: 'https://dummyimage.com/192x192', sizes: '192x192', type: 'image/png' },
                { src: 'https://dummyimage.com/256x256', sizes: '256x256', type: 'image/png' },
                { src: 'https://dummyimage.com/384x384', sizes: '384x384', type: 'image/png' },
                { src: 'https://dummyimage.com/512x512', sizes: '512x512', type: 'image/png' },
            ]
            });
            
        }
    })
    .catch(error => { console.log(error) });
    const actionHandlers = [
        ['play',          () => { audioPlayer.play(); }],
        ['pause',         () => { audioPlayer.pause(); }],
        ['previoustrack', () => { media("prev"); }],
        ['nexttrack',     () => { media("next"); }],
        ['stop',          () => { audioPlayer.pause();audioPlayer.currentTime = 0; }],
        ['seekbackward',  (details) => { audioPlayer.currentTime = audioPlayer.currentTime-(details.seekOffset || 10); }],
        ['seekforward',   (details) => { audioPlayer.currentTime = audioPlayer.currentTime+(details.seekOffset || 10); }],
        ['seekto',        (details) => { 
            if (details.fastSeek && 'fastSeek' in audioPlayer) {
                audioPlayer.fastSeek(details.seekTime);
                return;
            }
            audioPlayer.currentTime = details.seekTime;
        }],
    ];

    for (const [action, handler] of actionHandlers) {
        try {
        navigator.mediaSession.setActionHandler(action, handler);
        } catch (error) {
        console.log(`The media session action "${action}" is not supported yet.`);
        }
    }

    for (let i = 0; i < document.getElementsByClassName("file").length; i++) { 
        document.getElementsByClassName("file")[i].style = "";
    }
    document.getElementById(audiolinks[i][0]).style.color = "#009b00";
    lastplayed = i;
    console.log(prev);
}

audioPlayer.addEventListener("ended", function() {
    if (!loop) {
        lastplayed = lastplayed+1;
    }
    if (shuffle && !loop) {
        lastplayed = random(audiolinks.length-1);
    }
    playaudio(lastplayed);
});

audioPlayer.addEventListener("play", function() {
    playpausebtn.innerText = "pause";
});

audioPlayer.addEventListener("pause", function() {
    playpausebtn.innerText = "play";
});

filepicker.addEventListener('change', (event) => {
  	const files = event.target.files;

  	for (const file of files) {
        if (file.type.startsWith("audio") && !file.webkitRelativePath.split("/").pop().startsWith(".")) {
            const filesplit = file.webkitRelativePath.split("/");
            for (let i = 0; i < filesplit.length; i++) {
                var parent = document.querySelector('[id="'+filesplit[i-1]+'"]');
                if (i == 0) {
                    parent = document.querySelector('[id="folders"]');
                }
                if (i+1 != filesplit.length && !parent.querySelector('[id="'+filesplit[i]+'"]')) {
                    var folderdiv = document.createElement("div");
                    folderdiv.id = filesplit[i];
                    folderdiv.className = "folder";
                    folderdiv.innerText = filesplit[i];
                    if (!document.getElementById(filesplit[i-1])) {
                        folders.appendChild(folderdiv);
                    } else {
                        document.getElementById(filesplit[i-1]).appendChild(folderdiv)
                    }
                } else if (i+1 == filesplit.length && !document.querySelector('[id="'+file.webkitRelativePath+'"]')) {
                    var filediv = document.createElement("div");
                    filediv.id = file.webkitRelativePath;
                    filediv.className = "file";
                    filediv.innerText = filesplit[i];
                    audiolinks.push([file.webkitRelativePath, URL.createObjectURL(file)]);
                    filediv.setAttribute("onclick", 'playaudio('+(audiolinks.length-1)+');');
                    parent.appendChild(filediv); 
                } 
            }
        }
	}
});


</script>

</body>
</html>
